<?php

/**
 * @file
 *
 */

///// HOOKS /////

/**
 * Implements hook_menu().
 */
function pants_menu() {
  $items['pants/change/%user'] = array(
    'title' => 'Change pants',
    'page callback' => 'pants_change',
    'page arguments' => array(2),
    'access callback' => 'user_access', // Default.
    'access arguments' => array('change pants status'),
    'type' => MENU_CALLBACK,
  );
  $items['admin/config/people/pants'] = array(
    'title' => 'Pants',
    'description' => 'Administer pants.',
    'page callback' => 'pants_settings_form',
    'access callback' => 'user_access', // Defaut.
    'access arguments' => array('administer pants'),
    'type' => MENU_NORMAL_ITEM, // Default.
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function pants_permission() {
  return array(
    'change pants status' => array(
      'title' => t('Change pants status'),
     ),
    'administer pants' => array(
      'title' => t('Administer pants'),
    ),
  );
}

/**
 * Implements hook_form_FORM_ID_alter() for user_profile_form().
 */
function pants_form_user_profile_form_alter(&$form, &$form_state) {
  if ($form['#user_category'] == 'account' && user_access('change pants status')) {
    $account = $form_state['user'];
    $form['pants_status'] = array(
      '#type' => 'fieldset',
      '#title' => t('Pants'),
    );
    $form['pants_status']['pants'] = array(
      '#type' => 'checkbox',
      '#title' => t('Are you wearing pants?'),
      '#default_value' => !empty($account->pants) ? 1 : 0,
    );
  }
}

/**
 * Implements hook_user_presave().
 */
function pants_user_presave(&$edit, $account, $category) {
  if (isset($edit['pants'])) {
    pants_set($account->uid, $edit['pants']);
  }
}

/**
 * Implements hook_user_load().
 */
function pants_user_load($users) {
  $result = db_query('SELECT uid, status FROM {pants} WHERE uid IN (:uids)', array(
    ':uids' => array_keys($users),
  ));
  foreach ($result as $record) {
    $users[$record->uid]->pants = $record->status;
  }
}

/**
 * Implements hook_user_view().
 */
function pants_user_view($account, $view_mode, $langcode) {
  $account->content['summary']['pants'] = array(
    '#type' => 'user_profile_item',
    '#title' => t('Pants status'),
    '#markup' => theme('pants_status', array('account' => $account)),
  );
}

/**
 * Implements hook_theme().
 */
function pants_theme() {
  return array(
    'pants_status' => array(
      'variables' => array('account' => NULL),
    ),
  );
}

/**
 * Returns HTML for user's pants status.
 *
 * @param array $variables
 *   An associative array containing:
 *   - account: A user object whose pants status should be displayed.
 *
 * @ingroup themeable
 */
function theme_pants_status($variables) {
  $account = $variables['account'];
  return !empty($account->pants) ? t('On') : t('Off');
}

/**
 *
 */
function pants_settings_form() {
  return 'Oh hai.';
}

///// CRUD FUNCTIONS ////

/**
 * Toggles a user's pants setting to the opposite of what it is now.
 *
 * @param stdClass $user
 *   A user object.
 */
function pants_change($account) {
  $uid = $account->uid;
  $status = 1 - pants_get($uid);
  pants_set($uid, $status);
}

/**
 * Returns a user's current pants status.
 * 
 * @param int $uid
 *   A user's {users}.uid.
 *
 * @return int $status
 *   The user's pants status (1 or 0).
 */
function pants_get($uid) {
  $status = db_query('SELECT status FROM {pants} WHERE uid = :uid', array(
    ':uid' => $uid,
  ))->fetchField();
  return $status;
}

/**
 * Changes the value of a user's pants status.
 *
 * @param int $uid
 *   A user's {users}.uid.
 *
 * @return int $status
 *   A 1 or 0 with which to modify the user's pants status.
 */
function pants_set($uid, $status) {
  global $user;

  // Insert or update current row in {pants} table.
  db_merge('pants')
    ->key(array('uid' => $uid))
    ->fields(array(
      'uid' => $uid,
      'status' => $status,
    ))
    ->execute();

  // Also insert new record into {pants_history}.
  db_insert('pants_history')
    ->fields(array(
      'uid' => $uid,
      'status' => $status,
      'changed' => REQUEST_TIME,
      'changed_by' => $user->uid,
    ))
    ->execute();
}

/**
 * Returns text version of a given status.
 *
 * @param int $status
 *   A 1 or a 0 for a given pants status.
 */
function pants_status($status) {
  return ($status) ? t('On') : t('Off');
}
